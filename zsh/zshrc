# ----------------  Path Config -------------------- #

path=(
    $path
    $HOME/Copernicus/scripts/
    $HOME/Main/notes/scripts/
    $HOME/Main/expenses/scripts/
)

# Remove any duplicates
typeset -U path
path=($^path(N-/))

export PATH

# ----------------- Zsh Options -------------------- #

set -o vi

# Enable Colours
autoload -U colors && colors
#
# Enable history and place in cache
HISTSIZE=10000
SAVEHIST=10000
HISTFILE=~/.cache/zsh/history
setopt INC_APPEND_HISTORY # All shell sessions append to history after exiting
setopt HIST_IGNORE_DUPS # Consecutive repeated lines are ignored

# Edit command in vim buffer
autoload edit-command-line; zle -N edit-command-line
bindkey "^e" edit-command-line

# ------------ Environement Variables -------------- #

export EDITOR=nvim
export BROWSER=qutebrowser

export NOTESDIR="$HOME/Main/notes/"
export EXPENSES_DIR="$HOME/Main/expenses/"

# pyenv
export PYENV_ROOT="$HOME/.pyenv"
[[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
export PYENV_VIRTUALENV_DISABLE_PROMPT=1

export SSH_AUTH_SOCK=$XDG_RUNTIME_DIR/ssh-agent.socket

# ------------------- Plugins ---------------------- #

# Tab comletions
autoload -U compinit
zstyle ':completion:*' menu select
zmodload zsh/complist
compinit
_comp_options+=(globdots) # Include dot files

# Use vim keys in tab complete menu:
bindkey -M menuselect 'h' vi-backward-char
bindkey -M menuselect 'k' vi-up-line-or-history
bindkey -M menuselect 'l' vi-forward-char
bindkey -M menuselect 'j' vi-down-line-or-history

(cat ~/.cache/wal/sequences &) # Colours from wal

# Search history with ctrl-r
source /usr/share/zsh/plugins/zsh-fzf-history-search/zsh-fzf-history-search.zsh

# Auto suggestions
source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh

# Add syntax highlighting
source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# ------------------ Aliases --------------------- #

# There is some weirdness with kitty when using shh. They have
# an inbuild wrapper to copy some kitty info over when ussing
# ssh so functions like clear work correctly.
alias ssh="kitten ssh"

copy_to_copernicus() {
	rsync -v --info=progress2 $1 copernicus:$2
}

bpd() {
    # Kill existing tunnel
    pkill -f "ssh.*8050:localhost:8050" 2>/dev/null

    # Start detached SSH tunnel
    nohup ssh -f -N -L 8050:localhost:8050 copernicus >/dev/null 2>&1 &

    # Wait for connection
    sleep 2

    # Open browser
    $BROWSER http://localhost:8050 & disown

    exit
}
immich() {
    # Kill existing tunnel
    pkill -f "ssh.*2283:localhost:2283" 2>/dev/null

    # Start detached SSH tunnel
    nohup ssh -f -N -L 2283:localhost:2283 copernicus >/dev/null 2>&1 &

    # Wait for connection
    sleep 2

    # Open browser
    qutebrowser http://localhost:2283 & disown

    exit
}
photoprism() {
    # Kill existing tunnel
    pkill -f "ssh.*2342:localhost:2342" 2>/dev/null

    # Start detached SSH tunnel
    nohup ssh -f -N -L 2342:localhost:2342 copernicus >/dev/null 2>&1 &

    # Wait for connection
    sleep 2

    # Open browser
    qutebrowser http://localhost:2342 & disown

    exit
}
bluemap() {
    # Kill existing tunnel
    pkill -f "ssh.*8100:localhost:8100" 2>/dev/null

    # Start detached SSH tunnel
    nohup ssh -f -N -L 8100:localhost:8100 copernicus >/dev/null 2>&1 &

    # Wait for connection
    sleep 2

    # Open browser
    qutebrowser http://localhost:8100 & disown

    exit
}
ask_ollama() {
    # Kill existing tunnel
    pkill -f "ssh.*8080:localhost:8080" 2>/dev/null

    # Start detached SSH tunnel
    nohup ssh -f -N -L 8080:localhost:8080 copernicus >/dev/null 2>&1 &

    # Wait for connection
    sleep 2

    # Open browser
    qutebrowser http://localhost:8080 & disown

    exit
}

alias open="xdg-open & disown"
# Setting defaults for opening
xdg-mime default swayimg.desktop image/jpeg
xdg-mime default swayimg.desktop image/png
xdg-mime default org.pwmt.zathura.desktop application/pdf
# More to be added as we come across them

alias grep='grep --color=auto'

alias ls="exa"

alias ..='cd ..'
alias ...='cd ..; cd ..'
alias ....='cd ..; cd ..; cd ..'
alias .....='cd ..; cd ..; cd ..; cd ..;'

alias gst='git status'
alias ta='task add'

alias backup_to_home="rsync -a --delete --info=progress2 --exclude-from='/home/daraghhollman/Copernicus/.exclude_from_backup' -v -e 'ssh -p 22002' /home/daraghhollman/ daraghhollman@$(cat /home/daraghhollman/Copernicus/.home_ip):/home/daraghhollman/$(cat /proc/sys/kernel/hostname)_backup/"

alias hss='hugo server --noHTTPCache'
alias hsd='hugo server -D'

alias diasvpn="sudo openvpn --config /home/daraghhollman/Main/Work/vpn/dhollman.ovpn"

# Download from youtube
alias yt='yt-dlp --add-metadata -i'
alias yta='yt -x -f bestaudio/best'
alias ytp='yt --yes-playlist -x --audio-format best --audio-quality 0 --embed-metadata --embed-thumbnail --output "%(playlist_index)02d - %(title)s.%(ext)s"'

# Supress warnings
export PYTHONWARNINGS=ignore
# Papis helper functions
kpapis() {
	papis $@
	exit
}
bibexport() {
	papis export --format bibtex $1 | wl-copy
}
library_backup() {
	papis git add .
	papis git commit -m "Automated library backup $(date)"
	papis git push
}

# Yazi moves directory
function y() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
	yazi "$@" --cwd-file="$tmp"
	if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		builtin cd -- "$cwd"
	fi
	rm -f -- "$tmp"
}
zle -N y
bindkey "^o" y

# Defer pyenv init until needed
pyenv() {
	eval "$(command pyenv init - zsh)"
	eval "$(command pyenv virtualenv-init - zsh)"

	pyenv "$@"
}

alias fk="fuck"
eval "$(thefuck --alias)"

# Set prompt
eval "$(zoxide init zsh)"
eval "$(starship init zsh)"

# SSH AGENT
if ! pgrep -u "$USER" ssh-agent > /dev/null; then
    ssh-agent -t 24h > "$XDG_RUNTIME_DIR/ssh-agent.env"
fi
if [ ! -f "$SSH_AUTH_SOCK" ]; then
    source "$XDG_RUNTIME_DIR/ssh-agent.env" >/dev/null
fi
